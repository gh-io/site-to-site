#!/bin/bash

set -e

echo "ğŸš€ Starting FULL empire-wide security sweep..."
echo "==============================================="

# ----------------------------------------------
# 1. Create working directory
# ----------------------------------------------
mkdir -p all_repos
cd all_repos

echo "ğŸ“¥ Fetching ALL GitHub repos for Web4application..."
curl -s "https://api.github.com/users/Web4application/repos?per_page=200" \
  | jq -r '.[].clone_url' \
  | xargs -n 1 git clone

echo "ğŸ“¥ Fetching ALL Codeberg repos for Web4application..."
curl -s "https://codeberg.org/api/v1/users/Web4application/repos?limit=200" \
  | jq -r '.[].clone_url' \
  | xargs -n 1 git clone

echo "ğŸ“ All repos downloaded."
echo "-----------------------------------------------"

# ----------------------------------------------
# 2. Scan each repo for secrets
# ----------------------------------------------
echo "ğŸ” Scanning EVERY repo for leaked secrets..."

for repo in */; do
  echo "-------------------------------------------"
  echo "ğŸ” Checking: $repo"
  cd "$repo"

  echo "ğŸ“Œ File-based scan:"
  git grep -I -n "SECRET" . || true
  git grep -I -n "KEY" . || true
  git grep -I -n "TOKEN" . || true
  git grep -I -n "PASSWORD" . || true
  git grep -I -n "OPENAI" . || true
  git grep -I -n "API" . || true

  echo "ğŸ§¨ Trufflehog deep scan:"
  trufflehog git file://. --no-update || true

  cd ..
done

echo "ğŸ” Scan completed."
echo "-----------------------------------------------"

# ----------------------------------------------
# 3. Remove leaked .env files from ALL repos
# ----------------------------------------------
echo "ğŸ§¹ Cleaning .env files from commit history (if any)..."

for repo in */; do
  cd "$repo"

  if [ -f ".env" ] || [ -f ".env.local" ]; then
    echo "âš ï¸ Found .env in $repo â€” cleaning history..."
    git filter-repo --invert-paths \
      --path .env \
      --path .env.local \
      --force

    echo "â¬†ï¸ Force pushing clean history..."
    git push origin --force --all
  else
    echo "âœ”ï¸ No .env found in $repo"
  fi

  cd ..
done

echo "ğŸ§¼ All repos cleaned."
echo "-----------------------------------------------"

# ----------------------------------------------
# 4. Install global gitignore protection
# ----------------------------------------------
echo "ğŸ›¡ï¸ Installing global protection rules..."

git config --global core.excludesfile ~/.gitignore_global

cat <<EOF >> ~/.gitignore_global
.env
.env.*
*.local
*.secret
*.key
*.pem
*.p12
*.token
secrets/
keys/
EOF

echo "ğŸ”¥ Global .gitignore updated."
echo "-----------------------------------------------"

echo "ğŸ‰ FULL SECURITY SWEEP COMPLETED."
echo "Your entire repo empire is now fortified. ğŸš€"